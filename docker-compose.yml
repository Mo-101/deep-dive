# ================================
# AFRO STORM - Docker Compose
# Full Stack: Frontend + Backend
# ================================
#
# Usage:
#   docker-compose up --build     # Build and start all services
#   docker-compose up -d          # Start in background
#   docker-compose down           # Stop all services
#   docker-compose logs -f        # View logs
#
# Access:
#   Frontend: http://localhost:8080
#   Backend:  http://localhost:9000
#   API:      http://localhost:8080/api/v1/hazards/realtime
# ================================

services:
  # =========================
  # Backend - Python FastAPI
  # =========================
  backend:
    build:
      context: ./backend/afro-storm-pipeline
      dockerfile: Dockerfile
    container_name: afro-storm-backend
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - PYTHONUNBUFFERED=1
      # API Keys (from .env file)
      - OPENWEATHER_API_KEY=${VITE_OPENWEATHER_API}
      - COPERNICUS_USER=${COPERNICUS_USER:-}
      - COPERNICUS_PASS=${COPERNICUS_PASS:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - NEO4J_URI=${NEO4J_URI:-bolt://localhost:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-}
      # SMTP for alerts
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
    volumes:
      # Persist data between restarts
      - ./backend/afro-storm-pipeline/data:/app/data
      - ./backend/afro-storm-pipeline/outputs:/app/outputs
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - afro-storm-network

  # =========================
  # Frontend - Vite React
  # =========================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_MAPBOX_TOKEN=${VITE_MAPBOX_TOKEN}
        - VITE_OPENWEATHER_API=${VITE_OPENWEATHER_API}
        - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
        - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY}
    container_name: afro-storm-frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - afro-storm-network

  # =========================
  # Development Mode (optional)
  # Use: docker-compose --profile dev up
  # =========================
  frontend-dev:
    image: node:20-alpine
    container_name: afro-storm-frontend-dev
    profiles: [ "dev" ]
    working_dir: /app
    ports:
      - "8080:8080"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - VITE_MAPBOX_TOKEN=${VITE_MAPBOX_TOKEN}
      - VITE_OPENWEATHER_API=${VITE_OPENWEATHER_API}
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY}
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    depends_on:
      - backend
    networks:
      - afro-storm-network

  backend-dev:
    build:
      context: ./backend/afro-storm-pipeline
      dockerfile: Dockerfile
    container_name: afro-storm-backend-dev
    profiles: [ "dev" ]
    ports:
      - "9000:9000"
    volumes:
      - ./backend/afro-storm-pipeline:/app
    environment:
      - PYTHONUNBUFFERED=1
      - OPENWEATHER_API_KEY=${VITE_OPENWEATHER_API}
    command: python -m src.unified_server
    networks:
      - afro-storm-network

networks:
  afro-storm-network:
    driver: bridge
